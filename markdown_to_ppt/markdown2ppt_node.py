import json
from dataclasses import asdict
from markdown_to_ppt.ai_server import PPTNode, RootNode
import re

def seek_last_node(root_node: PPTNode, target_level: int) -> PPTNode:
    if len(root_node.children) == 0 or target_level == 0:
        return root_node

    target_level -= 1
    return seek_last_node(root_node.children[-1], target_level)

# 由于真实的ppt_node, 二级的level 是从0开始的，所以要减一
def reset_level(root_node: PPTNode):
    root_node.level -= 1
    for child in root_node.children:
        reset_level(child)

def tran_markdown_to_ppt_node(markdown_content: str) -> RootNode:
    title_pattern = re.compile(r"^(#+) (.*)$", re.DOTALL)
    lines = markdown_content.splitlines()
    file_title = lines[0].lstrip("# ")
    root_node = PPTNode(
        text=file_title,
        level=0,
        children=[]
    )
    temp_content_lines = []
    pre_node = root_node
    for line in lines[1:]:
        if line.strip() == "":
            continue
        match = title_pattern.match(line)
        if not match:
            temp_content_lines.append(line)
            continue
        markdown_tag, title = match.groups()
        level = len(markdown_tag)
        if level <= 1:
            temp_content_lines.append(line)
            continue
        if len(temp_content_lines) > 0:
            text = "\n".join(temp_content_lines)
            pre_node.children.append(PPTNode(
                text=text.lstrip("* "),
                level=pre_node.level+1,
                children=[]
            ))
        current_node = PPTNode(
            text=title,
            level=level - 1,
            children=[],
        )
        # 这里的思想是，如果是 ## 开头，那就是第二级，需要找一级的节点当爸爸, 在node 的level 中，如果是 ### 开头，那就是第三级标题， 要找最近的二级节点当爸爸
        seek_last_node(root_node, level - 2).children.append(current_node)
        temp_content_lines = []
        pre_node = current_node

    if len(temp_content_lines) > 0:
        text = "\n".join(temp_content_lines)
        pre_node.children.append(PPTNode(
            text=text.lstrip("* "),
            level=pre_node.level+1,
            children=[]
        ))

    reset_level(root_node)
    return RootNode(
        text=root_node.text,
        children=root_node.children,
    )

if __name__ == '__main__':
    content = "# 年终总结报告\n\n## 公司业绩回顾\n\n### 营收与利润分析\n\n#### 年度营收概况\n\n* 本年度公司实现总营收达到1.2亿人民币，较去年增长了15%，主要得益于新产品的市场推广和销售网络的拓展。\n\n#### 利润增长点分析\n\n* 利润增长主要来源于高附加值产品的销售，其中智能硬件产品线的利润贡献率提升了20%，成为公司利润增长的新引擎。\n\n#### 成本控制效果\n\n* 通过优化供应链管理和生产流程，公司有效控制了成本，使得整体利润率提升了5个百分点，达到22%。\n\n### 市场份额变化\n\n#### 主要市场表现\n\n* 在国内市场，公司产品线的市场份额提升了3个百分点，特别是在华东和华南地区，市场占有率分别增长了5%和4%。\n\n#### 国际市场拓展\n\n* 在国际市场，公司成功进入东南亚和中东市场，使得国际市场整体份额提升了2个百分点，达到10%。\n\n#### 竞争对手比较\n\n* 与主要竞争对手相比，公司市场份额增长速度领先，特别是在新兴市场，公司表现尤为突出，市场份额增长速度是竞争对手的两倍。\n\n### 重大合同与项目回顾\n\n#### 重要合同签订\n\n* 今年成功签订了与国内三大运营商的合作合同，总金额超过5000万人民币，为公司带来了稳定的收入来源。\n\n#### 关键项目实施\n\n* 成功实施了与某大型跨国企业的定制化项目，该项目不仅提升了公司在高端市场的品牌影响力，也为公司带来了约3000万人民币的收入。\n\n#### 合作伙伴发展\n\n* 与多家知名高校和研究机构建立了长期合作关系，共同开发新技术和产品，为公司的长远发展奠定了坚实的基础。\n\n## 业务发展与创新\n\n### 新产品与服务推出\n\n#### 新产品发布情况\n\n* 今年公司成功推出了三款新产品，包括一款智能穿戴设备和两款智能家居产品，均受到了市场的热烈欢迎。\n\n#### 服务创新举措\n\n* 推出了基于云计算的客户服务平台，提供24/7在线技术支持，显著提升了客户满意度和忠诚度。\n\n### 技术创新与研发进展\n\n#### 研发投入与成果\n\n* 本年度研发投资增长了20%，重点投入在人工智能和大数据分析领域，成功申请了5项新的技术专利。\n\n#### 技术合作与交流\n\n* 与国内外多家顶尖技术公司和研究机构建立了合作关系，共同开展前沿技术研究，加速了技术成果的转化。\n\n### 市场拓展与营销策略\n\n#### 新市场开拓成果\n\n* 成功进入五个新市场，包括东南亚、中东和东欧地区，新市场贡献了总营收的15%。\n\n#### 营销活动与效果\n\n* 通过线上线下结合的营销策略，举办了多场产品发布会和网络营销活动，有效提升了品牌知名度和市场占有率。\n\n#### 客户关系管理优化\n\n* 引入先进的CRM系统，对客户数据进行深度分析，实现了精准营销，提高了转化率和客户留存率。\n\n## 团队与人力资源\n\n### 员工结构与变动\n\n#### 年度员工流动率\n\n* 本年度公司员工流动率为10%，较去年下降了3个百分点，显示出公司员工稳定性有所提高。\n\n#### 关键岗位人才补充\n\n* 为填补关键岗位空缺，公司成功招聘了10名具有丰富经验的中高层管理人员，有效提升了团队的执行力和领导力。\n\n#### 年龄与性别分布\n\n* 公司员工年龄结构进一步优化，30岁以下员工比例提升至40%，性别比例更加均衡，女性员工比例达到45%。\n\n### 培训与发展计划\n\n#### 员工技能提升培训\n\n* 本年度共组织了50余次专业技能提升培训，覆盖了市场营销、产品开发、项目管理等多个领域，有效提升了员工的专业能力。\n\n#### 领导力发展项目\n\n* 实施了针对中高层管理者的领导力发展项目，通过案例分析、角色扮演和实战模拟等方式，增强了管理团队的领导力和决策能力。\n\n#### 员工职业规划指导\n\n* 提供了个性化的职业规划指导服务，帮助员工明确职业发展路径，激发了员工的工作热情和职业成长潜力。\n\n### 人才引进与激励机制\n\n#### 高层次人才引进\n\n* 通过与国内外高校合作，引进了5名博士和10名硕士，为公司的研发和创新工作注入了新鲜血液。\n\n#### 激励政策的优化\n\n* 优化了薪酬福利体系，实施了绩效奖金和股权激励计划，有效提升了员工的工作积极性和忠诚度。\n\n#### 员工认可与奖励\n\n* 设立了“年度优秀员工”和“创新贡献奖”等荣誉奖项，对表现突出的员工进行公开表彰和奖励，增强了团队的凝聚力和向心力。\n\n## 客户与市场反馈\n\n### 客户满意度调查结果\n\n#### 调查方法与覆盖范围\n\n* 通过在线问卷和电话访谈的方式，对过去一年内使用过我们产品和服务的客户进行了满意度调查，覆盖了超过1000名客户。\n\n#### 关键满意度指标\n\n* 客户满意度调查显示，产品满意度得分提升了10%，服务响应速度和问题解决效率是客户评价最高的两个方面。\n\n#### 改进措施与成效\n\n* 根据客户反馈，我们优化了售后服务流程，缩短了平均响应时间，并提高了问题解决率，客户重复购买率因此提升了15%。\n\n### 市场趋势与需求分析\n\n#### 当前市场趋势\n\n* 根据市场研究，当前市场趋势显示消费者更倾向于选择具有智能化、个性化特点的产品，对环保和可持续性产品的需求也在不断增长。\n\n#### 需求分析结果\n\n* 我们的产品线在智能化和个性化方面得到了市场的认可，特别是在年轻消费群体中，需求增长显著。\n\n#### 产品与服务调整\n\n* 针对市场趋势和需求分析结果，我们计划推出更多符合消费者个性化需求的产品，并加强环保材料的使用，以满足市场的新需求。\n\n### 竞争对手动态\n\n#### 主要竞争对手表现\n\n* 今年，我们的主要竞争对手在产品创新和市场扩张方面表现活跃，特别是在海外市场，他们的市场份额有所增加。\n\n#### 竞争策略分析\n\n* 竞争对手采取了价格战和产品差异化策略，试图在中低端市场和高端市场同时发力，对我们的市场份额构成了一定压力。\n\n#### 应对措施与策略\n\n* 针对竞争对手的策略，我们加强了品牌建设和市场营销，同时加大研发投入，以保持产品和服务的竞争力，并计划通过战略合作来扩大市场份额。\n\n## 风险管理与应对\n\n### 遇到的主要风险\n\n#### 市场风险分析\n\n* 在过去一年中，公司面临了激烈的市场竞争和需求波动，特别是在新兴市场，由于政策变动和经济波动，市场风险显著增加。\n\n#### 供应链风险评估\n\n* 由于全球供应链紧张，原材料成本上涨，公司面临了供应链中断的风险，这直接影响了产品的生产和交付周期。\n\n#### 技术安全风险\n\n* 随着数字化转型的深入，公司也面临了数据泄露和网络攻击的风险，这对公司的品牌信誉和客户信任构成了威胁。\n\n### 风险预防与控制措施\n\n#### 市场风险对冲策略\n\n* 为应对市场风险，公司建立了多元化的市场布局，通过开拓新市场和产品线来分散风险，并建立了灵活的定价机制以适应市场变化。\n\n#### 供应链管理优化\n\n* 加强与供应商的合作关系，建立长期稳定的供应链体系，并通过多元化采购策略降低单一供应商依赖风险。\n\n#### 技术安全加固\n\n* 加大对网络安全的投入，实施了先进的数据加密和访问控制技术，定期进行安全审计和漏洞扫描，确保技术安全。\n\n### 应急预案与执行情况\n\n#### 应急预案制定\n\n* 制定了详细的应急预案，包括市场突发事件、供应链中断和数据安全事件等，确保在风险发生时能够迅速响应。\n\n#### 应急演练与培训\n\n* 定期组织应急演练，提高员工对应急预案的理解和执行能力，确保在真实风险发生时能够有效应对。\n\n#### 应急措施执行效果\n\n* 在过去一年中，公司成功应对了两次供应链中断事件和一次数据泄露事件，通过执行应急预案，最小化了损失，并快速恢复了正常运营。\n\n## 未来规划与展望\n\n### 短期目标设定\n\n#### 业务增长目标\n\n* 在接下来的一年内，公司计划实现总营收增长18%，重点通过新产品线的推广和现有市场的深度开发来达成这一目标。\n\n#### 技术研发里程碑\n\n* 短期内，公司计划完成两项关键技术研发项目，包括人工智能算法优化和大数据分析平台的构建，以增强产品竞争力。\n\n#### 市场拓展计划\n\n* 计划进入两个新的国际市场，并在现有市场中增加三个新的销售点，以扩大公司的全球影响力和市场份额。\n\n### 长期发展战略\n\n#### 持续创新与研发\n\n* 长期来看，公司致力于成为行业内的技术领导者，计划在未来五年内，将研发投入占比提升至总营收的10%以上。\n\n#### 品牌国际化战略\n\n* 公司将实施品牌国际化战略，通过建立海外研发中心和营销网络，提升全球品牌知名度和市场占有率。\n\n#### 可持续发展与社会责任\n\n* 长期规划中，公司将重点关注可持续发展和社会责任，通过环保材料的使用和绿色生产流程，减少对环境的影响。\n\n### 投资与扩张计划\n\n#### 资本市场运作\n\n* 公司计划在未来三年内完成一次IPO，以筹集资金支持公司的快速扩张和长期发展计划。\n\n#### 新业务领域投资\n\n* 为实现业务多元化，公司计划投资于与主营业务相关的新兴领域，如智能健康设备和在线教育服务。\n\n#### 国际并购与合作\n\n* 公司将寻求国际并购机会，通过收购或合作的方式，快速进入新市场，并获取先进的技术和管理经验。\n\n"
    res = tran_markdown_to_ppt_node(content)
    print(json.dumps(asdict(res), ensure_ascii=False))